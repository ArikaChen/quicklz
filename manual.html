<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">

<head>
<meta http-equiv="Content-Language" content="da" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>size_t qlz_compress</title>
<style type="text/css">
.plain {
	font-family: verdana;
	font-size: 9pt;
}
.code {
	font-family: "Courier New";
	font-size: 10pt;
}
.style1 {
	font-family: verdana;
	font-size: large;
}
.style2 {
	font-family: Verdana;
}
.style3 {
	font-size: 9pt;
}
.style5 {
	font-weight: normal;
}
.style6 {
	font-family: verdana;
	font-size: large;
	text-align: center;
}
.style7 {
	text-align: center;
}
</style>
</head>

<body>

<p class="style6"><strong>QuickLZ 1.30 manual</strong></p>
<p class="plain">Last edited: 12-Aug-2007</p>
<p class="plain"><a href="#functions">Functions</a><br />
<a href="#flags">Flags</a><br />
<a href="#memory">Memory Requirements</a><br />
<a href="#architecture">Architecture Compatibility</a><br />
<a href="#backwards">Backwards Compatibility</a></p>
<p class="plain">QuickLZ supports four compression levels and optional streaming 
compression. Because of performance reasons, these and other settings must be 
defined through source code flags in the beginning of the<span class="plain"> quicklz.c</span> file 
whereafter the file must be compiled.</p>
<p class="plain">There are important issues for the <span class="code">COMPRESSION_LEVEL</span> and 
<span class="code">STREAMING_MODE</span> flags: Data compressed in level 0 can only be decompressed in 
level 0, and data must be decompressed with the same setting or value of 
<span class="code">STREAMING_MODE</span> as it was compressed. Carefully note the settings taken in use 
for future compatibility.</p>
<p class="style1"><strong><a name="functions"></a>Functions<br />
</strong><span class="style3">Following public functions exist i</span><span class="plain">n 
quicklz.c:</span></p>
<p class="style1"><span class="code"><strong>size_t qlz_compress(const void 
*source, char *destination, size_t size, char *scratch)</strong></span><span class="plain"><br />
Compress </span><span class="code">size</span><span class="plain"> amount of 
bytes of </span><span class="code">source</span><span class="plain"> and write 
the result to </span><span class="code">destination</span><span class="plain">.</span></p>
<p class="code"><span class="plain">The </span>size<span class="plain"> argument must be between 1 
byte and 4 Gbyte, also on 64-bit architectures even though the </span>size_t<span class="plain"> type is used.</span></p>
<p class="plain">The <span class="code">destination</span> buffer must be at 
least <span class="code">size</span> + 400 bytes large because incompressible 
data can increase slightly in size.</p>
<p class="plain">The <span class="code">scratch</span> argument must point at a 
buffer of size <span class="code">SCRATCH_COMPRESS</span> bytes which is 
required by the compression algorithm. <span class="code">
SCRATCH_COMPRESS</span> is a constant defined and calculated in the beginning of 
the quicklz.c file. Its value is between 32784 and 266256 bytes (see the Memory 
Requirements section), plus the value 
of <span class="code">STREAMING_MODE</span> if that flag is defined.</p>
<p class="plain">Return value: Size of compressed result.</p>
<p class="plain"><strong class="code">size_t qlz_decompress(const char *source, 
void *destination, char *scratch)<br />
</strong>Decompress <span class="code">source</span> and write the result to
<span class="code">destination</span>.</p>
<p class="plain">The <span class="code">scratch</span> argument must point at a 
buffer of size <span class="code">SCRATCH_DECOMPRESS</span> bytes. Its value is 
between 16 and 32784 bytes (see the Memory Requirements section), plus the value of <span class="code">STREAMING_MODE</span> 
if that flag is defined.</p>
<p class="plain">Return value: Size of decompressed result.</p>
<p><font style="FONT-SIZE: 9pt" face="Verdana"><b><span class="code">size_t 
qlz_size_decompressed(const char *source)</span><br />
</b>Takes the first 9 bytes of compressed data as argument (header) and returns 
its decompressed size.</font></p>
<p><font face="Verdana" class="plain">The function can be used to 
allocate the correct amount of memory for decompression.</font></p>
<p><b><font face="Verdana" class="code">size_t 
qlz_size_compressed(const char *source)</font></b><font face="Verdana"><br />
<span class="plain">Takes the first 9 bytes of compressed data as argument 
(header) and returns its entire 
compressed size.</span></font></p>
<p><font style="FONT-SIZE: 9pt" face="Verdana">The function can be used to read 
a block of compressed data from a file or storage device in cases where the 
size of the block is unknown.</font></p>
<p><font style="FONT-SIZE: 9pt" face="Verdana" class="code"><b>int qlz_get_setting(int 
setting)<br />
</b><span class="plain">This function gives access to source code constants that 
are not accessible when using QuickLZ in compiled form like a .dll library.</span></font></p>
<table style="width: 61%">
	<tr class="plain">
		<td style="width: 80px; height: 1px;">Argument</td>
		<td style="height: 1px; width: 385px">Return value</td>
	</tr>
	<tr class="plain">
		<td style="width: 80px">0</td>
		<td style="width: 385px"><span class="code">COMPRESSION_LEVEL</span></td>
	</tr>
	<tr class="plain">
		<td style="width: 80px">1</td>
		<td style="width: 385px"><span class="code">SCRATCH_COMPRESS</span></td>
	</tr>
	<tr class="plain">
		<td style="width: 80px">2</td>
		<td style="width: 385px"><span class="code">SCRATCH_DECOMPRESS</span></td>
	</tr>
	<tr class="plain">
		<td style="width: 80px">3</td>
		<td style="width: 385px"><span class="code">STREAMING_MODE</span> if defined, otherwise 0</td>
	</tr>
	<tr class="plain">
		<td style="width: 80px">4</td>
		<td style="width: 385px">1 if <span class="code">test_rle</span> is defined, otherwise 0</td>
	</tr>
	<tr class="plain">
		<td style="width: 80px">5</td>
		<td style="width: 385px">1 if <span class="code">speedup_incompressible</span> is defined, 
		otherwise 0</td>
	</tr>
	<tr class="plain">
		<td style="width: 80px">6</td>
		<td style="width: 385px">1 if <span class="code">memory_safe</span> is defined, otherwise 0</td>
	</tr>
	<tr>
		<td style="width: 80px" class="plain">7</td>
		<td style="width: 385px"><span class="code">QLZ_VERSION_MAJOR</span></td>
	</tr>
	<tr>
		<td style="width: 80px" class="plain">8</td>
		<td style="width: 385px"><span class="code">QLZ_VERSION_MINOR</span></td>
	</tr>
	<tr class="plain">
		<td style="width: 80px" class="plain">9</td>
		<td style="width: 385px"><span class="code">QLZ_VERSION_REVISION</span></td>
	</tr>
</table>
<p class="style1"><strong><a name="flags"></a>Flags<br />
</strong><span class="plain">Following flags exist in the beginning of the
quicklz.c file. </span></p>
<p class="code"><strong>COMPRESSION_LEVEL<br />
</strong><span class="plain">Four compression levels are supported:</span></p>
<p class="plain">Level 1 is roughly the same as used in version 1.00 to 1.20. 
Level 2 and 3 are compressing better but slower. Decompression speed is often 
fastest for data which has been compressed in level 3 because it results in more 
optimal and compact encoding.</p>
<p class="plain">Level 0 is using a new compression algorithm which is 
compressing faster and better than level 1 at the cost of decompression speed. 
Note that unless in streaming mode, level 0 has a time overhead at each call to
<span class="code">qlz_compress</span> 
and <span class="code">qlz_decompress</span> of that of initializing a 64/128 
Kbyte internal table on 32/64 bit processors and is thus not suited for small 
input data.</p>
<p class="plain">Compatibility: Data compressed in level 0 can only be 
decompressed in level 0. Level 1, 2 and 3 are mutually compatible; data 
compressed in any of 1, 2 or 3 can be decompressed in any of 1, 2 or 3.</p>
<p class="code"><strong>STREAMING_MODE<br />
</strong><font style="FONT-SIZE: 9pt" face="Verdana">Because LZ compression is 
based on finding repeated strings, compression ratio can degrade if a data 
entity is being split into smaller packets (less than 10 - 50 Kbyte) that are 
compressed individually. In that case, </font><span class="style2">define the
</span>STREAMING_MODE<font style="FONT-SIZE: 9pt" face="Verdana"> flag to a 
value to make 
QuickLZ store a history buffer of </font>STREAMING_MODE<font style="FONT-SIZE: 9pt" face="Verdana"> 
bytes in size.</font></p>
<p class="plain">Wh<span class="style2">en defined, following issues apply:</span></p>
<ul>
	<li>
	<p class="plain">The scratch buffers for <span class="code">qlz_compress</span> 
	and <span class="code">qlz_decompress</span> must be initially zero&#39;ed out 
	by the caller. 
	Their contents must be preserved and the same buffers must be passed at 
	each call.</p>
	</li>
	<li>
	<p class="plain">Packets must be decompressed in the same order as they were 
	compressed.</p>
	</li>
</ul>
<p class="plain">If <span class="code">STREAMING_MODE</span> is not defined, 
none of the issues apply. In particular, you can let <span class="code">
qlz_decompress</span> use the scratch buffer of <span class="code">qlz_compress</span> 
to save memory because it&#39;s guaranteed that <span class="code">SCRATCH_COMPRESS</span> 
&gt;= <span class="code">SCRATCH_DECOMPRESS</span>.</p>
<p class="plain">There is no flush function; <span class="code">qlz_compress</span> 
generates a compressed packet which can be stored or sent to a decompressing 
site immediately with no further delay.</p>
<p class="plain">Compatibility: Data must be decompressed with the same setting 
of STREAMING_MODE as it was compressed. If defined, it must have the same value.</p>
<p class="code"><strong class="plain"><span class="code">speedup_incompressible</span><br />
</strong><span class="plain">When defined, incompressible areas of the data are 
auto-detected and special handled to increase compression speed. The speed of 
decompression is not affected.&nbsp; </span></p>
<p class="code"><strong>test_rle</strong><span class="plain"><br />
When defined, sequences of the same byte (4 bytes or longer) are being special 
handled to increase both compression speed, decompression speed and compression 
ratio.</span></p>
<p class="code"><strong>memory_safe<br />
</strong><font style="FONT-SIZE: 9pt" face="Verdana">When defined, decompression 
with
<span class="code">qlz_decompress</span> cannot crash if fed with corrupted 
data. It ensures that no memory access, read nor write, can happen outside the 
following three byte intervals:</font></p>
<p><font style="FONT-SIZE: 9pt" face="Verdana" class="code"><span class="plain">
[</span>source<span class="plain"> ; </span>source + qlz_size_compressed(source) 
- 1<span class="plain">]</span><br />
<span class="plain">[</span>destination<span class="plain"> ; d</span>estination 
+ qlz_size_decompressed(source) - 1<span class="plain">]<br />
[</span><span class="style3">scratch</span><span class="plain"> ; </span>
<span class="code">scratch + SCRATCH_DECOMPRESS - 1</span><span class="plain">]<br />
</span></font><font style="FONT-SIZE: 9pt" face="Verdana"><br />
Before decompression the caller must test if the return values of
<span class="code">qlz_size_compressed</span> and <span class="code">
qlz_size_decompressed</span> are within range of allocated memory.</font></p>
<p><font style="FONT-SIZE: 9pt" face="Verdana">If <span class="code">
qlz_decompress</span> receives corrupted data with <span class="code">
memory_safe</span> defined, it will either return 0 or return </font>
<font style="FONT-SIZE: 9pt" face="Verdana" class="code">
qlz_size_decompressed(source)</font><font style="FONT-SIZE: 9pt" face="Verdana"> 
but with arbitrary decompressed data.</font></p>
<p><span class="plain">Defining</span><font style="FONT-SIZE: 9pt" face="Verdana"> the flag decreases 
decompression speed in the order of 20-25%. The speed of compression is not 
affected.</font></p>
<p><font style="FONT-SIZE: 9pt" face="Verdana">Note that the <span class="code">memory_safe</span> flag is 
new in QuickLZ and should not be assumed exploit safe against maliciously 
manipulated data. </font></p>

<p class="style1"><strong><a name="memory"></a>Memory Requirements<br />
</strong><span class="plain">The </span><span class="code">SCRATCH_COMPRESS</span><span class="plain"> 
and </span><span class="code">SCRATCH_DECOMPRESS</span><span class="plain"> 
constants have the values given in the table below, plus the value of </span>
<span class="code">STREAMING_MODE</span><span class="plain"> if that flag is 
defined.</span></p>
<table id="AutoNumber5" style="BORDER-COLLAPSE: collapse" borderColor="#111111" height="89" cellSpacing="0" borderColorDark="#000000" cellPadding="4" borderColorLight="#000000" border="1">
	<tr>
		<td borderColor="#000000" borderColorLight="#000000" align="right" borderColorDark="#000000" class="style5" style="width: 222px; height: 12px;">
		<font style="FONT-SIZE: 9pt" face="Verdana" class="code"><strong>
		sizeof(char *)</strong></font></td>
		<td borderColor="#000000" borderColorLight="#000000" align="middle" borderColorDark="#000000" colSpan="4" style="height: 12px">
		<font style="FONT-SIZE: 9pt" face="Verdana"><strong>32 bits</strong></font></td>
		<td borderColor="#000000" borderColorLight="#000000" align="middle" borderColorDark="#000000" colSpan="4" style="height: 12px">
		<font style="FONT-SIZE: 9pt" face="Verdana"><strong>64 bits</strong></font></td>
	</tr>
	<tr>
		<td borderColor="#000000" borderColorLight="#000000" align="right" borderColorDark="#000000" style="height: 13px; width: 222px" class="style5">
		<p align="right">
		<font style="FONT-SIZE: 9pt" face="Verdana" class="code"><strong>
		COMPRESSION_LEVEL</strong></font></p>
		</td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" style="height: 13px" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana"><strong>0</strong></font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" style="height: 13px" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana"><strong>1</strong></font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" style="height: 13px" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana"><strong>2</strong></font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" style="height: 13px" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana"><strong>3</strong></font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" style="height: 13px" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana"><strong>0</strong></font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" style="height: 13px" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana"><strong>1</strong></font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" style="height: 13px" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana"><strong>2</strong></font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" style="height: 13px" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana"><strong>3</strong></font></td>
	</tr>
	<tr>
		<td borderColor="#000000" borderColorLight="#000000" align="left" borderColorDark="#000000" class="style5" style="width: 222px">
		<font style="FONT-SIZE: 9pt" face="Verdana" class="code"><strong>
		SCRATCH_COMPRESS</strong></font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">32784 </font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">32784</font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">36880</font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">135184 </font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">65552</font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">65552</font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">69648</font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">266256</font></td>
	</tr>
	<tr>
		<td borderColor="#000000" borderColorLight="#000000" align="left" borderColorDark="#000000" class="style5" style="width: 222px">
		<font style="FONT-SIZE: 9pt" face="Verdana" class="code"><strong>
		SCRATCH_DECOMPRESS</strong></font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">16400 </font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">16</font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">16</font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">16</font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">32784</font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">16</font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">16</font></td>
		<td borderColor="#000000" borderColorLight="#000000" borderColorDark="#000000" class="style7">
		<font style="FONT-SIZE: 9pt" face="Verdana">16</font></td>
	</tr>
</table>
<p class="plain">QuickLZ does not allocate or use any memory except the caller 
given scratch 
buffers. </p>
<p><strong class="style1"><a name="architecture"></a>Architecture Compatibility<br />
</strong><span class="plain">QuickLZ has been extensively tested and bounds 
checked on a variety of architectures such as x86, x64, UltraSPARC, MIPS, 
Itanium, ARM, PA-RISC, Alpha, Cell and 68k. Data compressed on one architecture can be 
decompressed on any other architecture.</span></p>
<p class="plain">It is required <span class="plain">that sizeof(int) == 4 which 
</span>is the case for the 
ILP32, LP64 and LLP64 data models.</p>
<p><strong class="style1"><a name="backwards"></a>Backwards Compatibility<br />
</strong><span class="plain">To decompress data compressed with </span>
<span class="code">qlz_compress</span><span class="plain"> of version 1.20, 
undefine </span><span class="code">STREAMING_MODE</span><span class="plain"> and 
define </span><span class="code">COMPRESSION_LEVEL</span><span class="plain"> to 1, 
2 or 3.</span></p>
<p><span class="plain">To decompress data compressed with </span>
<span class="code">qlz_compress_packet</span><span class="plain"> of version 
1.20, define </span><span class="code">STREAMING_MODE</span><span class="plain"> 
to </span><span class="code">STREAM_BUFFER_SIZE</span><span class="plain"> - 
40000 and define </span><span class="code">COMPRESSION_LEVEL</span><span class="plain"> 
to 1, 2 or 3.</span></p>
<p class="plain">Version 1.30 is not compatible with versions older than 1.20.</p>

</body>

</html>
